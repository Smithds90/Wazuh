#!/bin/sh

# Copyright (C) 2015, Wazuh Inc.
# All rights reserved.
# Wazuh.com

# This program is free software; you can redistribute it
# and/or modify it under the terms of the GNU General Public
# License (version 2) as published by the FSF - Free Software
# Foundation.

# Shell script that updates 'vulnerability-detector' to 'vulnerability-detection'

# Function: isVulnerabilityDetectorInstalled
# Description: that checks if the old (< v4.8) 'Vulnerability Detector' configuration is present.
# Parameters:
#   $1: Path to the ossec.conf file.
isVulnerabilityDetectorInstalled()
{
    local OSSEC_CONFIGURATION_FILE="$1"
    local VULNERABILITY_DETECTOR_PATTERN="<vulnerability-detector>"

    if ( grep -q "$VULNERABILITY_DETECTOR_PATTERN" "$OSSEC_CONFIGURATION_FILE" ); then
        return 0
    fi

    return 1
}

# Function: updateVulnerabilityDetector
# Description: Function that updates the old (< v4.8) 'Vulnerability Detector' configuration with the latest one.
# Parameters:
#   $1: Path to the ossec.conf file.
#   $2: Path to the new 'Vulnerability Detection' template.
#   $3: Path to the new 'Indexer' template.
updateVulnerabilityDetector()
{
    local OSSEC_CONFIGURATION_FILE="$1"

    if isVulnerabilityDetectorInstalled "$OSSEC_CONFIGURATION_FILE"; then 
        local OSSEC_CONFIGURATION_FILE_TMP="$1.tmp"
        local VULN_TEMPLATE="$2"
        local INDEXER_TEMPLATE="$3"

        touch $OSSEC_CONFIGURATION_FILE_TMP

        local OSSEC_CONFIGURATION_FILE_BEFORE_VD="$(sed -ne '/<vulnerability-detector>/q;p' $OSSEC_CONFIGURATION_FILE)"
        local OSSEC_CONFIGURATION_FILE_AFTER_VD="$(sed -e '1,/<\/vulnerability-detector>/d' $OSSEC_CONFIGURATION_FILE)"

        # Append current config preceding the old 'Vulnerability Detector' config.
        printf "%s\n\n" "${OSSEC_CONFIGURATION_FILE_BEFORE_VD}" >> $OSSEC_CONFIGURATION_FILE_TMP
        printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

        # Append new 'Vulnerability Detection' config.
        cat ${VULN_TEMPLATE} >> $OSSEC_CONFIGURATION_FILE_TMP
        printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

        # Append new 'Indexer' config.
        cat ${INDEXER_TEMPLATE} >> $OSSEC_CONFIGURATION_FILE_TMP
        printf "\n" >> $OSSEC_CONFIGURATION_FILE_TMP

        # Append current config succeeding the old 'Vulnerability Detector' config.
        printf "%s\n\n" "$OSSEC_CONFIGURATION_FILE_AFTER_VD" >> $OSSEC_CONFIGURATION_FILE_TMP

        mv $OSSEC_CONFIGURATION_FILE_TMP $OSSEC_CONFIGURATION_FILE
    fi
}
