name: decoder/windows_powershell/0

sources: 
  - decoder/windows_event_decoder/0

metadata:
  description: Decoder for Windows Powershell events

check:
  - ~windows.Event.System.Channel.#text: +s_eq/Windows PowerShell

normalize:
 - map:
   - event.module: powershell
   - event.kind: event
   - event.category: process
   - event.type: info

  ## Process fields.
   - process.entity_id: $~windows.Event.EventData.HostId
   - process.command_line: $~windows.Event.EventData.HostApplication
   - process.title: $~windows.Event.EventData.HostName

  ## User fields.
   - ~temp.user_parts: +s_to_array/$~windows.Event.EventData.UserId/\
   - user.domain: $~temp.user_parts.0
   - user.name: $~temp.user_parts.1
   - related.user: +a_append/user.name

  ## PowerShell fields.
   - powershell.engine.new_state: $~windows.Event.EventData.NewEngineState
   - powershell.engine.previous_state: $~windows.Event.EventData.PreviousEngineState
   - powershell.provider.new_state: $~windows.Event.EventData.NewProviderState
   - powershell.provider.name: $~windows.Event.EventData.ProviderName
   - powershell.total: $~windows.Event.EventData.DetailTotal
   - powershell.sequence: $~windows.Event.EventData.DetailSequence
   - powershell.engine.version: $~windows.Event.EventData.EngineVersion
   - powershell.pipeline_id: $~windows.Event.EventData.PipelineId
   - powershell.runspace_id: $~windows.Event.EventData.RunspaceId
   - powershell.process.executable_version: $~windows.Event.EventData.HostVersion
   - powershell.command.value: $~windows.Event.EventData.CommandLine
   - powershell.command.path: $~windows.Event.EventData.CommandPath
   - powershell.command.name: $~windows.Event.EventData.CommandName
   - powershell.command.type: $~windows.Event.EventData.CommandType
  
  # Add file information.
   - file.path: $~windows.Event.EventData.ScriptName
   - file.name: +r_ext/$file.path/^.*\\(.*[\\.].*)$
   - file.directory: +r_ext/$file.path/^(.*\\).*[\\.].*$
   - file.extension: +r_ext/$file.path/^.*\\.*[\\.](.*)$

 - check: event.code==400
   map:
    - event.type: start

 - check: event.code==403
   map:
    - event.type: end

# Cleanup
 - map:
   - ~temp: +ef_delete
   - ~windows: +ef_delete