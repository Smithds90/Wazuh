name: decoder/windows_sysmon/0

sources: 
  - decoder/windows_event_channel/0

metadata:
  description: Decoder for Windows Sysmon events

check:
  - ~event_channel.Event.System.Provider.@Name: Microsoft-Windows-Sysmon

parse:
  logpar:
    - ~event_channel.Event.EventData.Hashes: <~temp.hashes/kv_map/=/,>

normalize:
 - map:
    - event.module: sysmon
    - event.kind: event
    
    
    # Add categorization fields
    - event:  +kvdb_get_merge/win_sysmon_categories/$event.code 

    - rule.name: $~event_channel.Event.EventData.RuleName
    - event.Hashes: $~event_channel.Event.EventData.Hash
    
    
  ## Process fields
    - process.entity_id: $~event_channel.Event.EventData.ProcessGuid
    - process.pid: $~event_channel.Event.EventData.ProcessId
    - process.executable: $~event_channel.Event.EventData.Image
    - process.entity_id: $~event_channel.Event.EventData.SourceProcessGuid
    - process.entity_id: $~event_channel.Event.EventData.SourceProcessGUID 
    - process.pid: $~event_channel.Event.EventData.SourceProcessId
    - process.thread.id: $~event_channel.Event.EventData.SourceThreadId
    - process.executable: $~event_channel.Event.EventData.SourceImage
    - process.executable: $~event_channel.Event.EventData.Destination
    - process.command_line: $~event_channel.Event.EventData.CommandLine
    - process.working_directory: $~event_channel.Event.EventData.CurrentDirectory
    - process.parent.entity_id: $~event_channel.Event.EventData.ParentProcessGuid
    - process.parent.pid: $~event_channel.Event.EventData.ParentProcessId
    - process.parent.executable: $~event_channel.Event.EventData.ParentImage
    - process.parent.command_line: $~event_channel.Event.EventData.ParentCommandLine
    

 - check: event.code==255 
   map:
    - error.code: $event.code

 - check: event.code==25
   map:
    - event.message: $~event_channel.Event.EventData.Type

 - check: event.code!=7
   map:
   - process.pe.original_file_name: $~event_channel.Event.EventData.OriginalFileName

