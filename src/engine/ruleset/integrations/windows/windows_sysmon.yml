name: decoder/windows_sysmon/0

sources: 
  - decoder/windows_event_channel/0

metadata:
  description: Decoder for Windows Sysmon events

check:
  - ~event_channel.Event.System.Provider.@Name: Microsoft-Windows-Sysmon


normalize:
 - map:
    - event.module: sysmon
    - event.kind: event
    
    # Add categorization fields
    - event:  +kvdb_get_merge/win_sysmon_categories/$event.code 

    - rule.name: $~event_channel.Event.EventData.RuleName
    - event.Hashes: $~event_channel.Event.EventData.Hash
    
    
  ## Process fields
    - process.entity_id: $~event_channel.Event.EventData.ProcessGuid
    - process.pid: $~event_channel.Event.EventData.ProcessId
    - process.executable: $~event_channel.Event.EventData.Image
    - process.entity_id: $~event_channel.Event.EventData.SourceProcessGuid
    - process.entity_id: $~event_channel.Event.EventData.SourceProcessGUID 
    - process.pid: $~event_channel.Event.EventData.SourceProcessId
    - process.thread.id: $~event_channel.Event.EventData.SourceThreadId
    - process.executable: $~event_channel.Event.EventData.SourceImage
    - process.executable: $~event_channel.Event.EventData.Destination
    - process.command_line: $~event_channel.Event.EventData.CommandLine
    - process.working_directory: $~event_channel.Event.EventData.CurrentDirectory
    - process.parent.entity_id: $~event_channel.Event.EventData.ParentProcessGuid
    - process.parent.pid: $~event_channel.Event.EventData.ParentProcessId
    - process.parent.executable: $~event_channel.Event.EventData.ParentImage
    - process.parent.command_line: $~event_channel.Event.EventData.ParentCommandLine
    - ~temp.hashes: +parse_kv/$~event_channel.Event.EventData.Hashes/=/,/'/'
    - related.hash: $~temp.hashes

    # - process.args-> requires args parsing, perhaps can be done with logparse or regex
    # - process.args_count
    # - process.parent.args
    # - process.parent.args_count


    #- process.name -> requires negative index on array
    #- process.parent.name -> requires negative index on array
    
  ## File fields
    - file.path: $~event_channel.Event.EventData.TargetFilename
    - file.path: $~event_channel.Event.EventData.Device
    - file.name: $~event_channel.Event.EventData.PipeName
    - file.path: $~event_channel.Event.EventData.ImageLoaded
    - file.code_signature.subject_name: $~event_channel.Event.EventData.Signature
    - file.code_signature.status: $~event_channel.Event.EventData.SignatureStatus
    - file.code_signature.signed: $~event_channel.Event.EventData.Signed
    - file.directory: +r_ext/$file.path/^(.*\\).*[\\.].*$
    - file.extension: +r_ext/$file.path/^.*\\.*[\\.](.*)$
    - file.name: +r_ext/$file.path/^.*\\(.*[\\.].*)$

  ## Network, Destination, and Source fields
    - network.transport: $~event_channel.Event.EventData.Protocol
    - network.protocol: $~event_channel.Event.EventData.DestinationPortName
    - network.protocol: $~event_channel.Event.EventData.SourcePortName
    - source.ip: $~event_channel.Event.EventData.SourceIp
    - source.domain: $~event_channel.Event.EventData.SourceHostname
    - source.port: $~event_channel.Event.EventData.SourcePort
    - destination.ip: $~event_channel.Event.EventData.DestinationIp
    - destination.domain: $~event_channel.Event.EventData.DestinationHostname
    - destination.port: $~event_channel.Event.EventData.DestinationPort
    - dns.question.name: $~event_channel.Event.EventData.QueryName
  
  ## User fields
    - user.id: ~event_channel.Event.System.Security.@UserID
    - ~temp.user_parts: +s_to_array/$~event_channel.Event.EventData.User/\
    - user.domain: $~temp.user_parts.0
    - user.name: $~temp.user_parts.1

  ## Sysmon fields
    - sysmon.dns.status: $~event_channel.Event.EventData.QueryStatus
    - sysmon.dns.status: +kvdb_get/sysmon_dns_status/$~event_channel.Event.EventData.QueryStatus
    - sysmon.file.archived: $~event_channel.Event.EventData.Archived
    - sysmon.file.is_executable: $~event_channel.Event.EventData.IsExecutable

  ## Related fields
    - related.user: user.name
    - related.ip: +a_append/$~event_channel.Event.EventData.NewTargetUserName  

 - check: event.code==255 
   map:
    - error.code: $event.code

 - check: event.code==25
   map:
    - event.message: $~event_channel.Event.EventData.Type

 - check: event.code!=7
   map:
   - process.pe.original_file_name: $~event_channel.Event.EventData.OriginalFileName
   - process.pe.company: $~event_channel.Event.EventData.Company
   - process.pe.description: $~event_channel.Event.EventData.Description
   - process.pe.file_version: $~event_channel.Event.EventData.FileVersion
   - process.pe.product: $~event_channel.Event.EventData.Product

 - check: event.code==7
   map:
    - file.pe.original_file_name: $~event_channel.Event.EventData.OriginalFileName
    - file.pe.company: $~event_channel.Event.EventData.Company
    - file.pe.description: $~event_channel.Event.EventData.Description
    - file.pe.file_version: $~event_channel.Event.EventData.FileVersion
    - file.pe.product: $~event_channel.Event.EventData.Product

 - check: event.code==22
   map:
    - network.protocol: dns

 - check: $~event_channel.Event.EventData.SignatureStatus==Valid
   map:
    - file.code_signature.valid: True   

 - check: $~event_channel.Event.EventData.Initiated==True
   map:
    - network.direction: egress  

 - check: $~event_channel.Event.EventData.Initiated==false
   map:
    - network.direction: ingress

 - check: $~event_channel.Event.EventData.SourceIsIpv6==true
   map:
    - network.type: ipv6

 - check: $~event_channel.Event.EventData.SourceIsIpv6==false
   map:
    - network.type: ipv4

 - check: event.code==1 OR event.code==23  OR event.code==24 OR event.code==25 OR event.code==26
   map:
    - process.hash: $~temp.hashes
    - process.pe.imphash: process.hash.imphash

 - check: event.code==6 OR event.code==7  OR event.code==15
   map:
    - file.hash: $~temp.hashes
    - file.pe.imphash: file.hash.imphash