---
name: decoder/upgrade/0

metadata:
    module: wazuh-agent/upgrade
    title: Upgrade Confirmation events
    description: >
        Decodes Upgrade confirmation messages
    compatibility: >
        This decoder has been tested on Wazuh version 4.4.0
    versions:
      - "4.4.0"
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2023/03/22
    references:
        - https://documentation.wazuh.com/current/user-manual/agents/remote-upgrading/upgrading-agent.html#upgrading-agent
        - https://documentation.wazuh.com/current/user-manual/agents/remote-upgrading/agent-upgrade-module.html

sources:
  - decoder/queue-upgrade/0

check:
  - event.original: +starts_with/{
  - agent.id: +exists

# Examples:
# https://github.com/wazuh/wazuh/issues/5406
# {"command":"upgrade_update_status","parameters":{"error":0,"message":"Upgrade was successful","status":"Done"}}
# {"command":"upgrade_update_status","parameters":{"error":2,"message":"Upgrade Failed","status":"Failed"}}

parse:
  logpar:
    - event.original: <~json/json>

normalize:
  - check:
      - ~json.parameters: +is_object
    map:
      - ~json.parameters.agents: +array_append/$agent.id
      - ~tmp.send_result: +upgrade_confirmation_send/$~json

  - check:
      - ~tmp.send_result: +is_true
    map:
      - ~tmp.result: success

  # Cleanup
  # - map:
      # - ~tmp: +delete
      # - ~json: +delete

