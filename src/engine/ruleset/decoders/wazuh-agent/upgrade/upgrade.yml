---
name: decoder/upgrade/0

metadata:
    module: wazuh-agent/upgrade
    title: Upgrade Confirmation events
    description: >
        Decodes Upgrade confirmation messages
    compatibility: >
        This decoder has been tested on Wazuh version 4.4.0
    versions:
      - "4.4.0"
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2023/03/22
    references:
        - https://documentation.wazuh.com/current/user-manual/agents/remote-upgrading/upgrading-agent.html#upgrading-agent
        - https://documentation.wazuh.com/current/user-manual/agents/remote-upgrading/agent-upgrade-module.html

sources:
  - decoder/queue-upgrade/0

check:
  - event.original: +s_starts/{
  - agent.id: +ef_exists

# Examples:
# https://github.com/wazuh/wazuh/issues/5406
# {"origin":{"module":"api"},"command":"upgrade","parameters":{"agents":[5,6],"wpk_repo":"packages.wazuh.com/4.x/wpk/","version":"v4.0.0","use_http":false,"force_upgrade":false}}
# {"origin":{"module":"api"},"command":"upgrade_custom","parameters":{"agents":[20,23],"file_path":"/home/user/agent.wpk","installer":"custom-upgrade-script.sh"}}
# {"origin":{"module":"upgrade_module"},"command":"upgrade_update_status","parameters":{"agents":[20],"error":0,"data":"Upgrade Successful","status":"Done"}}

parse:
  logpar:
    - event.original: <~json/json>

normalize:
  - check:
      - ~json.parameters: +t_is_object
    map:
      - ~json.parameters.agents: +a_append/$agent.id
      - ~tmp.send_result: +upgrade_confirmation_send/$~json

  - check:
      - ~tmp.send_result: +t_is_true
    map:
      - ~tmp.result: success

  # Cleanup
  - map:
      - ~tmp: +ef_delete
      - ~json: +ef_delete

