name: decoder/syscollector-process-save/0

sources:
  - decoder/syscollector-process/0

metadata:
    module: wazuh-agent/syscollector/syscollector-process-save
    title: Syscollector Decoder event for process save
    description: >
        Fourth stage filter of syscollector event decoder with type starting with
        "process" and process object available, if succes will query to wdb
        -> for wazuh managers with versions lower than 4.4
    compatibility: >
        This decoder has been tested on Wazuh version 4.3.
    author:
        name: Wazuh, Inc.
        url: https://wazuh.com
        date: 2022/11/08
    references:
        - https://documentation.wazuh.com/current/user-manual/capabilities/syscollector.html#using-syscollector-information-to-trigger-alerts
        - https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/wodle-syscollector.html
        - https://documentation.wazuh.com/current/user-manual/reference/daemons/wazuh-db.html#syscollector-tables
        - https://github.com/wazuh/wazuh/issues/13521

check:
  - ~json.process: +ef_exists

normalize:
  - check:
      - ~json.timestamp: +ef_not_exists
    map:
      - ~json.timestamp: "NULL"

  - check:
      - ~json.process.pid: +ef_not_exists
    map:
      - ~json.process.pid: "NULL"

  - check:
      - ~json.process.name: +ef_not_exists
    map:
      - ~json.process.name: "NULL"

  - check:
    - ~json.process.state: +ef_not_exists
    map:
      - ~json.process.state: "NULL"

  - check:
      - ~json.process.ppid: +ef_not_exists
    map:
      - ~json.process.ppid: "NULL"

  - check:
      - ~json.process.utime: +ef_not_exists
    map:
      - ~json.process.utime: "NULL"

  - check:
      - ~json.process.stime: +ef_not_exists
    map:
      - ~json.process.stime: "NULL"

  - check:
      - ~json.process.cmd: +ef_not_exists
    map:
      - ~json.process.cmd: "NULL"

  - check:
      - ~json.process.argvs: +ef_exists
    map:
      - ~argvs_csv_str: +s_from_array/$~json.process.argvs/,

  - check:
      - ~json.process.argvs: +ef_not_exists
    map:
      - ~argvs_csv_str: "NULL"

  - check:
      - ~json.process.euser: +ef_not_exists
    map:
      - ~json.process.euser: "NULL"

  - check:
      - ~json.process.ruser: +ef_not_exists
    map:
      - ~json.process.ruser: "NULL"

  - check:
      - ~json.process.suser: +ef_not_exists
    map:
      - ~json.process.suser: "NULL"

  - check:
      - ~json.process.egroup: +ef_not_exists
    map:
      - ~json.process.egroup: "NULL"

  - check:
      - ~json.process.rgroup: +ef_not_exists
    map:
      - ~json.process.rgroup: "NULL"

  - check:
      - ~json.process.sgroup: +ef_not_exists
    map:
      - ~json.process.sgroup: "NULL"

  - check:
      - ~json.process.fgroup: +ef_not_exists
    map:
      - ~json.process.fgroup: "NULL"

  - check:
      - ~json.process.priority: +ef_not_exists
    map:
      - ~json.process.priority: "NULL"

  - check:
      - ~json.process.nice: +ef_not_exists
    map:
      - ~json.process.nice: "NULL"

  - check:
      - ~json.process.size: +ef_not_exists
    map:
      - ~json.process.size: "NULL"

  - check:
      - ~json.process.vm_size: +ef_not_exists
    map:
      - ~json.process.vm_size: "NULL"

  - check:
      - ~json.process.resident: +ef_not_exists
    map:
      - ~json.process.resident: "NULL"

  - check:
      - ~json.process.share: +ef_not_exists
    map:
      - ~json.process.share: "NULL"

  - check:
      - ~json.process.start_time: +ef_not_exists
    map:
      - ~json.process.start_time: "NULL"

  - check:
      - ~json.process.pgrp: +ef_not_exists
    map:
      - ~json.process.pgrp: "NULL"

  - check:
      - ~json.process.session: +ef_not_exists
    map:
      - ~json.process.session: "NULL"

  - check:
      - ~json.process.nlwp: +ef_not_exists
    map:
      - ~json.process.nlwp: "NULL"

  - check:
      - ~json.process.tgid: +ef_not_exists
    map:
      - ~json.process.tgid: "NULL"

  - check:
      - ~json.process.tty: +ef_not_exists
    map:
      - ~json.process.tty: "NULL"

  - check:
      - ~json.process.processor: +ef_not_exists
    map:
      - ~json.process.processor: "NULL"

  - map:
      - ~query: +s_concat/agent /$agent.id/ process save /$~json.ID/|/$~json.timestamp/|/$~json.process.pid/|/$~json.process.name/|/$~json.process.state/|/$~json.process.ppid/|/$~json.process.utime/|/$~json.process.stime/|/$~json.process.cmd/|/$~argvs_csv_str/|/$~json.process.euser/|/$~json.process.ruser/|/$~json.process.suser/|/$~json.process.egroup/|/$~json.process.rgroup/|/$~json.process.sgroup/|/$~json.process.fgroup/|/$~json.process.priority/|/$~json.process.nice/|/$~json.process.size/|/$~json.process.vm_size/|/$~json.process.resident/|/$~json.process.share/|/$~json.process.start_time/|/$~json.process.pgrp/|/$~json.process.session/|/$~json.process.nlwp/|/$~json.process.tgid/|/$~json.process.tty/|/$~json.process.processor
      - ~process_save_result: +wdb_update/$~query
