---
name: decoder/syscollector-dbsync-host-data/0

metadata:
  module: wazuh-agent/event-enrichment/syscollector
  title: Host data from Syscollector DBSync events
  description: Extracts host data from Syscollector DBSync events
  compatibility: This decoder has been tested on Wazuh version 4.3
  author:
    name: Wazuh, Inc.
    url: https://wazuh.com
    date: 2023/01/02
  references:
    - https://github.com/wazuh/wazuh/issues/15500

sources:
  - decoder/syscollector-dbsync-network-address-inserted/0
  - decoder/syscollector-dbsync-network-address/0
  - decoder/syscollector-dbsync-network-iface-inserted/0
  - decoder/syscollector-dbsync-network-iface/0
  - decoder/syscollector-dbsync-osinfo-inserted/0
  - decoder/syscollector-dbsync-osinfo/0

check:
  - ~do_update_kvdb: +t_is_true
  # TODO: Delete operation are not yet implemented
  - ~json.operation: +s_ne/DELETED

normalize:
  - map:
      - host.architecture: $~json.data.architecture
      - host.hostname: $~json.data.hostname
      - host.name: $~json.data.hostname
      - host.os.kernel: $~json.data.release
      - host.os.name: $~json.data.os_name
      - host.os.platform: $~json.data.os_platform
      # TODO: check if sysname is one of the accepted values
      - host.os.type: +s_lo/$~json.data.sysname
      - host.os.version: $~json.data.os_version
  - check:
      - $~json.data.os_display_version: +ef_exists
    map:
      - host.os.type: windows

  - check: +ef_exists/host.mac AND +ef_exists/~json.data.mac AND +ef_exists/~json.data.name
    map:
      - ~mac_aux: +a_append/$~json.data.mac
      - host.mac: +ef_merge/$~mac_aux
  - check: +ef_not_exists/host.mac AND +ef_exists/~json.data.mac AND +ef_exists/~json.data.name
    map:
      - host.mac: +a_append/$~json.data.mac

  - check: +ef_exists/host.ip AND +ef_exists/~json.data.address AND +ef_exists/~json.data.iface
    map:
      - ~address_aux: +a_append/$~json.data.address
      - host.ip: +ef_merge/$~address_aux
  - check: +ef_not_exists/host.ip AND +ef_exists/~json.data.address AND +ef_exists/~json.data.iface
    map:
      - host.ip: +a_append/$~json.data.address

