---
name: decoder/ciscat/0

parents:
  - decoder/json/0

metadata:
  description: Decoder for Wazuh's integration with CIS-CAT logs
  references:
    - https://documentation.wazuh.com/current/user-manual/capabilities/policy-monitoring/ciscat/ciscat.html
  product.name: ciscat

# Example log:
# {"type":"scan_info","scan_id":1886296483,"cis":{"benchmark":"CIS Ubuntu Linux 16.04 LTS Benchmark","profile":"xccdf_org.cisecurity.benchmarks_profile_Level_2_-_Server","hostname":"10-206-u20-agent4","timestamp":"2022-09-16T15:09:53.048Z","pass":90,"fail":93,"error":0,"unknown":1,"notchecked":36,"score":"49.5%"}}

check:
  - wazuh.queue: 101
  - wazuh.origin: "wodle_cis-cat"
  - _json.cis: +exists
  - _json.type: +s_eq/scan_info

normalize:
  - check:
      - _json.scan_id: +not_exists
    map:
      _json.scan_id: "NULL"

  - check:
      - _json.cis.timestamp: +not_exists
    map:
      _json.cis.timestamp: "NULL"

  - check:
      - _json.cis.benchmark: +not_exists
    map:
      _json.cis.benchmark: "NULL"

  - check:
      - _json.cis.profile: +not_exists
    map:
      _json.cis.profile: "NULL"

  - check:
      - _json.cis.pass: +not_exists
    map:
      _json.cis.pass: "NULL"

  - check:
      - _json.cis.fail: +not_exists
    map:
      _json.cis.fail: "NULL"

  - check:
      - _json.cis.error: +not_exists
    map:
      _json.cis.error: "NULL"

  - check:
      - _json.cis.notchecked: +not_exists
    map:
      _json.cis.notchecked: "NULL"

  - check:
      - _json.cis.unknown: +not_exists
    map:
      _json.cis.unknown: "NULL"

  - check:
      - _json.cis.score: +exists
    map:
      _json.cis.score: +s_trim/end/%

  - check:
      - _json.cis.score: +not_exists
    map:
      _json.cis.score: "NULL"

  - map:
      _query: +s_concat/agent /$agent.id/ ciscat save /$_json.scan_id/|/$_json.cis.timestamp/|/$_json.cis.benchmark/|/$_json.cis.profile/|/$_json.cis.pass/|/$_json.cis.fail/|/$_json.cis.error/|/$_json.cis.notchecked/|/$_json.cis.unknown/|/$_json.cis.score
      _query_response: +wdb_update/$_query
