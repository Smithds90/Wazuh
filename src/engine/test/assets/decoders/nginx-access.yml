---
name: decoder/nginx-access/0

metadata:
  description: Parses nginx access logs

check:
  - event.original: +ef_exists

parse:
  logpar:
    # "lessons.example.com 192.168.10.111 - - [10/Jul/1992:10:11:12 -0700] \"GET /SOMEWEB/RANGE/coolvideo.mp4 HTTP/1.1\" 206 7654321 \"http://web.com/SOMEWEB/RANGE/coolvideo.mp4\" \"Mozilla/5.0 (Linux; Android 5.1.1; KFFOWI) AppleWebKit/527.36 (KHTML, like Gecko) Silk/81.2.16 like Chrome/81.0.404.123 Safari/527.36\""
    - event.original: >-
        <destination.domain> <source.ip> - <user.name> [<timestamp/HTTPDATE>] "<http.request.method>
        <url.original> HTTP/<http.version>" <http.response.status_code> <http.response.body.bytes>
        "<http.request.referrer>" "<user_agent.original>"
    - event.original: >-
        <source.ip> - <user.name> [<timestamp/HTTPDATE>] "<http.request.method>
        <url.original> HTTP/<http.version>" <http.response.status_code> <http.response.body.bytes>
        "<http.request.referrer>" "<user_agent.original>"

normalize:
  - map:
      - url.domain: $destination.domain
      - event.kind: event
      - event.category: +s_append/web
      - event.type: +s_append/access
      - related.ip: +s_append/$source.ip/$destination.ip
      - related.user: +s_append/$user.name

  - check:
      - http.response.status_code: +i_lt/400
    map:
      - event.outcome: success
  - check:
      - http.response.status_code: +i_ge/400
    map:
      - event.outcome: failure
