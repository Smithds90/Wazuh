---
name: decoder/apache-access/0

metadata:
  description: Parses Apache HTTPD access logs in its Common Log Format

check:
  - wazuh.queue: 49
  - event.original: +ef_exists

parse:
  logpar:
      # ::1 - - [10/Jul/1992:10:07:13 +0200] \"GET /someicon.ico HTTP/1.1\" 404 209
      - event.original: <source.ip> - - [<timestamp/HTTPDATE>] "<http.request.method> <url.original> HTTP/<http.version>" <http.response.status_code> <http.response.body.bytes>
      # 192.168.8.69 - - [10/Jul/1992:10:07:13 +0000] \"GET / HTTP/1.1\" 200 484 \"-\" \"Mozilla/4.0 (Macintosh; Intel Mac OS X 10_12_0) SomeApp/911.22 (KHTML, like Gecko) Chrome/20.0.2005.99 Safari/547.36\"
      - event.original: <source.ip> - - [<timestamp/HTTPDATE>] "<http.request.method> <url.original> HTTP/<http.version>" <http.response.status_code> <http.response.body.bytes> "-" "<user_agent.original>"
      # 127.0.0.1 - - [10/Jul/1992:10:33:45 +0100] \"-\" 406 152 \"-\" \"-\"
      - event.original: <source.ip> - - [<timestamp/HTTPDATE>] "-" <http.response.status_code> <http.response.body.bytes> "-" "-"
      # some-server - - [29/May/2017:13:32:46 +0000] \"GET /status HTTP/1.1\" 200 612 \"-\" \"Mozilla/5.0 (Windows NT 6.7; rv:13.0) Lizzard/21122716 Firefox/15.0a2\"
      - event.original: <source.address> - - [<timestamp/HTTPDATE>] "<http.request.method> <url.original> HTTP/<http.version>" <http.response.status_code> <http.response.body.bytes> "-" "<user_agent.original>"
      # ::1 - - [10/Jul/1992:10:07:13 +0200] \"-\" 406 -
      - event.original: <source.ip> - - [<timestamp/HTTPDATE>] "-" <http.response.status_code> -
      - event.original: '[<timestamp/HTTPDATE>] <source.ip> TLSv<tls.version> <tls.cipher> "<http.request.method> <url.original> HTTP/<http.version>" <http.response.body.bytes>'
      - event.original: '[<timestamp/HTTPDATE>] <source.ip> TLSv<tls.version> <tls.cipher> "<http.request.method> <url.original> HTTP/<http.version>" -'

normalize:
  - map:
     - event.kind: event
     - event.dataset: apache.access
     - event.category: +s_append/web
     - event.module: apache
     - service.type: apache
     - event.outcome: success
  - check:
      - http.response.status_code: +i_gt/399
    map:
      - event.outcome: failure
