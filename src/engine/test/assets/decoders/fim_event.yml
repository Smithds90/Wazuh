---
name: fim_event

parents:
  - fim

check:
  - _fimEventOriginal.type: +s_eq/event
  - _fimEventOriginal.data.path: +is_string
  - _fimEventOriginal.data.type: +is_string

normalize:
  - map:
      _do_save2: false

  - check:
      - _fimEventOriginal.data.type: +s_eq/added
    map:
      _do_save2: true
  - check:
      - _fimEventOriginal.data.type: +s_eq/modified
    map:
      _do_save2: true

  - check:
      - _do_save2: +is_true
    map:
      _fimEventOriginal.data.audit: +delete_field
      _fimEventOriginal.data.content_changes: +delete_field
      _fimEventOriginal.data.changed_attributes: +delete_field
      _fimEventOriginal.data.hard_links: +delete_field
      _fimEventOriginal.data.mode: +delete_field
      _fimEventOriginal.data.old_attributes: +delete_field
      _fimEventOriginal.data.type: +delete_field
      _fimEventOriginal.data.tags: +delete_field
      # TODO: adapt concat to fully convert from json object to string (or create a HF to do so)
      _query: +s_concat/agent /$agent.id/ syscheck save2 /$_fimEventOriginal.data
      _query_result: +wdb_query/$_query

  - check:
      - _do_save2: +is_false
      - _fimEventOriginal.data.type: +s_eq/deleted
    map:
      _query: +s_concat/agent /$agent.id/ syscheck delete /$_fimEventOriginal.data.path
      _query_result: +wdb_query/$_query
