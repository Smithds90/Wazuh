---
name: aws-s3

metadata:
  description: Decoder for Amazon S3 server access logs
  references:
    - https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html
  product.name: Amazon S3 server access

parents:
  - aws

# Example of Wazuh's integration with AWS S3 server access log:
# {
#   "aws": {
#     "authentication_type": "AuthHeader",
#     "bucket_owner": "79a59df900b949e55d96a1e698fbacedfd6e09d98eacf8f8d5218e7cd47ef2be",
#     "bucket": "awsexamplebucket1",
#     "bytes_sent": 2662992,
#     "cipher_suite": "ECDHE-RSA-AES128-GCM-SHA256",
#     "error_code": "NoSuchBucket",
#     "host_header": "s3.us-west-2.amazonaws.com",
#     "host_id": "s9lzHYrFp76ZVxRcpX9+5cjAnEH2ROuNkd2BHfIa6UkFVdtjf5mKR3/eTPFvsiP/XV/VLi31234=",
#     "http_status": 200,
#     "key": "/photos/2019/08/puppy.jpg",
#     "object_sent": 3462992,
#     "operation": "REST.GET.VERSIONING",
#     "referer": "http://www.amazon.com/webservices",
#     "remote_ip": "192.0.2.3",
#     "request_id": "3E57427F3EXAMPLE",
#     "request_uri": "GET /awsexamplebucket1/photos/2019/08/puppy.jpg?x-foo=bar HTTP/1.1",
#     "requester": "79a59df900b949e55d96a1e698fbacedfd6e09d98eacf8f8d5218e7cd47ef2be",
#     "signature_version": "SigV2",
#     "source": "s3_server_access",
#     "time": "06/Feb/2019:00:00:38 +0000",
#     "tls_version": "TLSv1.2",
#     "total_time": 70,
#     "turn_around_time": 10,
#     "user_agent": "curl/7.15.1",
#     "version_id": "3HL4kqtJvjVBH40Nrjfkd"
#   },
#   "integration": "aws"
# }

check:
  - wazuh.modules.aws.source: +s_eq/s3_server_access

# TODO: improve the multiple parsing (instead of using multiple files)
parse:
  logql:
    - _json.aws.request_uri: <http.request.method> <http.url.original> HTTP/<http.version>
    - _json.aws.request_uri: <http.request.method> <http.url.original> http/<http.version>

normalize:
  - check:
      - _json.aws.error_code: +exists
    map:
      event.outcome: failure

  - check:
      - _json.aws.error_code: +not_exists
    map:
      event.outcome: success

  - map:
      aws.s3access.authentication_type: $_json.aws.authentication_type
      aws.s3access.bucket_owner: $_json.aws.bucket_owner
      aws.s3access.bucket: $_json.aws.bucket
      aws.s3access.bytes_sent: $_json.aws.bytes_sent
      aws.s3access.cipher_suite: $_json.aws.cipher_suite
      aws.s3access.error_code: $_json.aws.error_code
      aws.s3access.host_header: $_json.aws.host_header
      aws.s3access.host_id: $_json.aws.host_id
      aws.s3access.http_status: $_json.aws.http_status
      aws.s3access.key: $_json.aws.key
      aws.s3access.object_size: $_json.aws.object_sent
      aws.s3access.operation: $_json.aws.operation
      aws.s3access.referrer: $_json.aws.referer
      aws.s3access.remote_ip: $_json.aws.remote_ip
      aws.s3access.request_id: $_json.aws.request_id
      aws.s3access.request_uri: $_json.aws.request_uri
      aws.s3access.requester: $_json.aws.requester
      aws.s3access.signature_version: $_json.aws.signature_version
      aws.s3access.tls_version: $_json.aws.tls_version
      aws.s3access.total_time: $_json.aws.total_time
      aws.s3access.turn_around_time: $_json.aws.turn_around_time
      aws.s3access.user_agent: $_json.aws.user_agent
      aws.s3access.version_id: $_json.aws.version_id

      client.address: $_json.aws.remote_ip
      client.ip: $_json.aws.remote_ip
      client.user.id: $_json.aws.requester

      cloud.provider: aws

      event.action: $_json.aws.operation
      event.category: +s_append/web
      event.code: $_json.aws.error_code
      event.duration: $_json.aws.total_time # ms - ECS transforms this field to nanoseconds
      event.id: $_json.aws.request_id
      event.kind: event
      event.type: +s_append/access

      http.request.referrer: $_json.aws.referer
      http.response.body.bytes: $_json.aws.bytes_sent
      http.response.status_code: $_json.aws.http_status

      related.ip: +s_append/$_json.aws.remote_ip
      related.user: +s_append/$_json.aws.bucket_owner

      timestamp: $_json.aws.time

      tls.cipher: $_json.aws.cipher_suite

      _json: +delete_field
