name: syscollector_dbsync_osinfo_inserted

parents:
  - syscollector_dbsync_base

check:
  - _json.type: +s_eq/dbsync_osinfo
  - _json.operation: +s_eq/INSERTED

normalize:
  - check:
      - _json.data.scan_time: +not_exists
    map:
      _json.data.scan_time: ""

  - check:
      - _json.data.hostname: +s_ne//
    map:
      _json.data.hostname: +s_replace/|/$_escaped_pipe_char
      _json.data.hostname: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.hostname: +s_eq//
    map:
      _json.data.hostname: "NULL"
  - check:
      - _json.data.hostname: +not_exists
    map:
      _json.data.hostname: ""

  - check:
      - _json.data.architecture: +s_ne//
    map:
      _json.data.architecture: +s_replace/|/$_escaped_pipe_char
      _json.data.architecture: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.architecture: +s_eq//
    map:
      _json.data.architecture: "NULL"
  - check:
      - _json.data.architecture: +not_exists
    map:
      _json.data.architecture: ""

  - check:
      - _json.data.os_name: +s_ne//
    map:
      _json.data.os_name: +s_replace/|/$_escaped_pipe_char
      _json.data.os_name: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.os_name: +s_eq//
    map:
      _json.data.os_name: "NULL"
  - check:
      - _json.data.os_name: +not_exists
    map:
      _json.data.os_name: ""

  - check:
      - _json.data.os_version: +not_exists
    map:
      _json.data.os_version: ""

  - check:
      - _json.data.os_codename: +s_ne//
    map:
      _json.data.os_codename: +s_replace/|/$_escaped_pipe_char
      _json.data.os_codename: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.os_codename: +s_eq//
    map:
      _json.data.os_codename: "NULL"
  - check:
      - _json.data.os_codename: +not_exists
    map:
      _json.data.os_codename: ""

  - check:
      - _json.data.os_major: +not_exists
    map:
      _json.data.os_major: ""

  - check:
      - _json.data.os_minor: +not_exists
    map:
      _json.data.os_minor: ""

  - check:
      - _json.data.os_patch: +s_ne//
    map:
      _json.data.os_patch: +s_replace/|/$_escaped_pipe_char
      _json.data.os_patch: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.os_patch: +s_eq//
    map:
      _json.data.os_patch: "NULL"
  - check:
      - _json.data.os_patch: +not_exists
    map:
      _json.data.os_patch: ""

  - check:
      - _json.data.os_build: +not_exists
    map:
      _json.data.os_build: ""

  - check:
      - _json.data.os_platform: +s_ne//
    map:
      _json.data.os_platform: +s_replace/|/$_escaped_pipe_char
      _json.data.os_platform: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.os_platform: +s_eq//
    map:
      _json.data.os_platform: "NULL"
  - check:
      - _json.data.os_platform: +not_exists
    map:
      _json.data.os_platform: ""

  - check:
      - _json.data.sysname: +s_ne//
    map:
      _json.data.sysname: +s_replace/|/$_escaped_pipe_char
      _json.data.sysname: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.sysname: +s_eq//
    map:
      _json.data.sysname: "NULL"
  - check:
      - _json.data.sysname: +not_exists
    map:
      _json.data.sysname: ""

  - check:
      - _json.data.release: +not_exists
    map:
      _json.data.release: ""

  - check:
      - _json.data.version: +not_exists
    map:
      _json.data.version: ""

  - check:
      - _json.data.os_release: +not_exists
    map:
      _json.data.os_release: ""

  - check:
      - _json.data.checksum: +not_exists
    map:
      _json.data.checksum: ""
  
  - check:
      - _json.data.os_display_version: +not_exists
    map:
      _json.data.os_display_version: ""

  - check:
      - _json.data.triaged: +s_ne//
    map:
      _json.data.triaged: +s_replace/|/$_escaped_pipe_char
      _json.data.triaged: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.triaged: +s_eq//
    map:
      _json.data.triaged: "NULL"
  - check:
      - _json.data.triaged: +not_exists
    map:
      _json.data.triaged: ""

  - check:
      - _json.data.reference: +s_ne//
    map:
      _json.data.reference: +s_replace/|/$_escaped_pipe_char
      _json.data.reference: +s_replace/NULL/_NULL_  
  - check:
      - _json.data.reference: +s_eq//
    map:
      _json.data.reference: "NULL"
  - check:
      - _json.data.reference: +not_exists
    map:
      _json.data.reference: ""

  - map:
      _query: +s_concat/agent /$agent.id/ dbsync osinfo /$_json.operation/ /$_json.data.scan_time/|/$_json.data.hostname/|/$_json.data.architecture/|/$_json.data.os_name/|/$_json.data.os_version/|/$_json.data.os_codename/|/$_json.data.os_major/|/$_json.data.os_minor/|/$_json.data.os_patch/|/$_json.data.os_build/|/$_json.data.os_platform/|/$_json.data.sysname/|/$_json.data.release/|/$_json.data.version/|/$_json.data.os_release/|/$_json.data.checksum/|/$_json.data.os_display_version/|/$_json.data.triaged/|/$_json.data.reference/|
      _query_response: +wdb_update/$_query

  - check:
      - _query_response: +is_true
    map:
      #TODO: need to find where to map resultant neccesary fields
      _json.data.hostname: +s_replace/$_escaped_pipe_char/|
      _json.os.hostname: $_json.data.hostname
      _json.data.architecture: +s_replace/$_escaped_pipe_char/|
      _json.os.architecture: $_json.data.architecture
      _json.data.os_name: +s_replace/$_escaped_pipe_char/|
      _json.os.name: $_json.data.os_name
      _json.os.version: $_json.data.os_version
      _json.data.os_codename: +s_replace/$_escaped_pipe_char/|
      _json.os.codename: $_json.data.os_codename
      _json.os.major: $_json.data.os_major
      _json.os.minor: $_json.data.os_minor
      _json.data.os_patch: +s_replace/$_escaped_pipe_char/|
      _json.os.patch: $_json.data.os_patch
      _json.os.build: $_json.data.os_build
      _json.data.os_platform: +s_replace/$_escaped_pipe_char/|
      _json.os.platform: $_json.data.os_platform
      _json.data.sysname: +s_replace/$_escaped_pipe_char/|
      _json.os.sysname: $_json.data.sysname
      _json.os.release: $_json.data.release
      #_json.os.version: $_json.data.version -> TODO: duplicated value on the original
      _json.os.os_release: $_json.data.os_release
      _json.os.display_version: $_json.data.os_display_version
      _query: +delete_field
      _query_response: +delete_field
      _json.data: +delete_field
      _escaped_pipe_char: +delete_field
