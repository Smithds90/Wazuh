name: decoder_syscollector_port

parents:
  - decoder_syscollector_base

check:
  - type: +exists

normalize:
  # decode_port
  #ID (scan_id)
  # type == port || type == port_end
  - check:
    - _pre_conditions: +i_eq/1
    - event.original.type: +s_eq/port_end
    - event.original.ID: +exists
    map:
      _decode_port_section: 1

  - check:
    - _pre_conditions: +i_eq/1
    - event.original.type: +s_eq/port
    - event.original.ID: +exists
    map:
      _decode_port_section: 1

    #timestamp
  - check:
    - event.original.port: +exist
    - event.original.timestamp: +not_exists
    map:
      event.original.timestamp: "NULL"
    #port.protocol
  - check:
    - event.original.port: +exist
    - event.original.port.protocol: +not_exists
    map:
      event.original.port.protocol: "NULL"
    #port.local_ip
  - check:
    - event.original.port: +exist
    - event.original.port.local_ip: +not_exists
    map:
      event.original.port.local_ip: "NULL"
    #port.local_port
  - check:
    - event.original.port: +exist
    - event.original.port.local_port: +not_exists
    map:
      event.original.port.local_port: "NULL"
    #port.remote_ip
  - check:
    - event.original.port: +exist
    - event.original.port.remote_ip: +not_exists
    map:
      event.original.port.remote_ip: "NULL"
    #port.remote_port
  - check:
    - event.original.port: +exist
    - event.original.port.remote_port: +not_exists
    map:
      event.original.port.remote_port: "NULL"
    #port.tx_queue
  - check:
    - event.original.port: +exist
    - event.original.port.tx_queue: +not_exists
    map:
      event.original.port.tx_queue: "NULL"
    #port.rx_queue
  - check:
    - event.original.port: +exist
    - event.original.port.rx_queue: +not_exists
    map:
      event.original.port.rx_queue: "NULL"
    #port.inode
  - check:
    - event.original.port: +exist
    - event.original.port.inode: +not_exists
    map:
      event.original.port.inode: "NULL"
    #port.state
  - check:
    - event.original.port: +exist
    - event.original.port.state: +not_exists
    map:
      event.original.port.state: "NULL"
    #port.PID
  - check:
    - event.original.port: +exist
    - event.original.port.PID: +not_exists
    map:
      event.original.port.PID: "NULL"
    #port.process
  - check:
    - event.original.port: +exist
    - event.original.port.process: +not_exists
    map:
      event.original.port.process: "NULL"

  - check:
    - _decode_port_section: +i_eq/1
    map:
      _query_save: +s_concat/agent /$event.original.agent.id /port save /$event.original.ID/|$event.original.timestamp/|$event.original.port.protocol/|$event.original.port.local_ip/|$event.original.port.local_port/|$event.original.port.remote_ip/|$event.original.port.remote_port/|$event.original.port.tx_queue/|$event.original.port.rx_queue/|$event.original.port.inode/|$event.original.port.state/|$event.original.port.PID/|$event.original.port.process
      _port_save_response: +wdb_update/$_query_save

  - check:
    - _decode_port_section: +i_eq/1
    - event.original.port: +not_exists
    - event.original.type: +s_eq/port_end
    - _prev_port_id: +s_neq/$event.original.ID
    map:
      _query_del: +s_concat/agent /$event.original.agent.id /port del /$event.original.ID
