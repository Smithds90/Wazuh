name: syscollector_program_save

parents:
  - syscollector_program

check:
  - _syscollectorEventOriginal.program: +exists

normalize:
  - check:
      - _syscollectorEventOriginal.timestamp: +not_exists
    map:
      _syscollectorEventOriginal.timestamp: "NULL"

  - check:
      - _syscollectorEventOriginal.program.format: +not_exists
    map:
      _syscollectorEventOriginal.program.format: "NULL"

  - check:
      - _syscollectorEventOriginal.program.name: +not_exists
    map:
      _syscollectorEventOriginal.program.name: "NULL"

  - check:
      - _syscollectorEventOriginal.program.priority: +not_exists
    map:
      _syscollectorEventOriginal.program.priority: "NULL"

  - check:
      - _syscollectorEventOriginal.program.group: +not_exists
    map:
      _syscollectorEventOriginal.program.group: "NULL"

  - check:
      - _syscollectorEventOriginal.program.size: +not_exists
    map:
      _syscollectorEventOriginal.program.size: "NULL"

  - check:
      - _syscollectorEventOriginal.program.vendor: +not_exists
    map:
      _syscollectorEventOriginal.program.vendor: "NULL"

  - check:
      - _syscollectorEventOriginal.program.install_time: +not_exists
    map:
      _syscollectorEventOriginal.program.install_time: "NULL"

  - check:
      - _syscollectorEventOriginal.program.version: +not_exists
    map:
      _syscollectorEventOriginal.program.version: "NULL"

  - check:
      - _syscollectorEventOriginal.program.architecture: +not_exists
    map:
      _syscollectorEventOriginal.program.architecture: "NULL"

  - check:
      - _syscollectorEventOriginal.program.multi-arch: +not_exists
    map:
      _syscollectorEventOriginal.program.multi-arch: "NULL"

  - check:
      - _syscollectorEventOriginal.program.source: +not_exists
    map:
      _syscollectorEventOriginal.program.source: "NULL"

  - check:
      - _syscollectorEventOriginal.program.description: +not_exists
    map:
      _syscollectorEventOriginal.program.description: "NULL"

  - check:
      - _syscollectorEventOriginal.program.location: +not_exists
    map:
      _syscollectorEventOriginal.program.location: "NULL"

    #Obtain hexDigest with name version and arch
  - check:
      - _syscollectorEventOriginal.program.name: +exists
      - _syscollectorEventOriginal.program.version: +exists
      - _syscollectorEventOriginal.program.architecture: +exists
    map:
      _hexDigest: +sha1_from/$_syscollectorEventOriginal.program.name/$_syscollectorEventOriginal.program.version/$_syscollectorEventOriginal.program.architecture

  - check:
      _hexDigest: +is_string
    map:
      _query: +s_concat/agent /$_syscollectorEventOriginal.agent.id/ package save /$_syscollectorEventOriginal.ID/|/$_syscollectorEventOriginal.timestamp/|/$_syscollectorEventOriginal.format/|/$_syscollectorEventOriginal.name/|/$_syscollectorEventOriginal.priority/|/$_syscollectorEventOriginal.group/|/$_syscollectorEventOriginal.size/|/$_syscollectorEventOriginal.vendor/|/$_syscollectorEventOriginal.install_time/|/$_syscollectorEventOriginal.version/|/$_syscollectorEventOriginal.architecture/|/$_syscollectorEventOriginal.multi-arch/|/$_syscollectorEventOriginal.source/|/$_syscollectorEventOriginal.description/|/$_syscollectorEventOriginal.location/|/$_hexDigest
      _package_save_result: +wdb_update/$_query
