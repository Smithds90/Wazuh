name: syscollector_program_save

parents:
  - syscollector_program

check:
  - event.original.program: +exists

normalize:
  - check:
      - event.original.timestamp: +not_exists
    map:
      event.original.timestamp: "NULL"

  - check:
      - event.original.program.format: +not_exists
    map:
      event.original.program.format: "NULL"

  - check:
      - event.original.program.name: +not_exists
    map:
      event.original.program.name: "NULL"

  - check:
      - event.original.program.priority: +not_exists
    map:
      event.original.program.priority: "NULL"

  - check:
      - event.original.program.group: +not_exists
    map:
      event.original.program.group: "NULL"

  - check:
      - event.original.program.size: +not_exists
    map:
      event.original.program.size: "NULL"

  - check:
      - event.original.program.vendor: +not_exists
    map:
      event.original.program.vendor: "NULL"

  - check:
      - event.original.program.install_time: +not_exists
    map:
      event.original.program.install_time: "NULL"

  - check:
      - event.original.program.version: +not_exists
    map:
      event.original.program.version: "NULL"

  - check:
      - event.original.program.architecture: +not_exists
    map:
      event.original.program.architecture: "NULL"

  - check:
      - event.original.program.multi-arch: +not_exists
    map:
      event.original.program.multi-arch: "NULL"

  - check:
      - event.original.program.source: +not_exists
    map:
      event.original.program.source: "NULL"

  - check:
      - event.original.program.description: +not_exists
    map:
      event.original.program.description: "NULL"

  - check:
      - event.original.program.location: +not_exists
    map:
      event.original.program.location: "NULL"

    #Obtain hexDigest with name version and arch
  - check:
      - event.original.program.name: +exists
      - event.original.program.version: +exists
      - event.original.program.architecture: +exists
    map:
      _hexDigest: +sha1_from/$event.original.program.name/$event.original.program.version/$event.original.program.architecture

  - map:
      _query: +s_concat/agent /$event.original.agent.id /package save /$event.original.ID/|/$event.original.timestamp/|/$event.original.format/|/$event.original.name/|/$event.original.priority/|/$event.original.group/|/$event.original.size/|/$event.original.vendor/|/$event.original.install_time/|/$event.original.version/|/$event.original.architecture/|/$event.original.multi-arch/|/$event.original.source/|/$event.original.description/|/$event.original.location/|/$_hexDigest
      _package_save_result: +wdb_update/$_query
