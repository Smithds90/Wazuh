name: decoder_syscollector_hardware
check:
  - queue: +i_eq/64 #SYSCOLLECTOR_MQ
  - location: +exists

normalize:
  - check:
    - location: +s_starts/(
    - location: +s_not_contains/>
    map:
      _check_1: true

  - check:
    - location: +s_starts/(
    - location: +s_not_contains/>syscollector
    map:
      _check_2: true

  - check:
    - location: +s_ne/syscollector
    map:
      _check_3: true

  - check:
    - _can_continue: NOT ($check_1 OR $check_2 OR $check_3)
    - event.original.type: +exists
    map:
      _pre_conditions: 1

  # decode_hardware
  #ID (scan_id)
  # type == hardware
  - check:
    - _pre_conditions: +i_eq/1
    - event.original.type: +s_eq/hardware
    - event.original.inventory: +exists
    map:
      _decode_hardware_section: 1

    #timestamp
  - check:
    - event.original.inventory: +exist
    - event.original.timestamp: +not_exists
    map:
      event.original.timestamp: "NULL"

    #inventory.board_serial
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.board_serial: +not_exists
    map:
      event.original.inventory.board_serial: "NULL"
    #fill hardware.serial
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.board_serial: +exists
    map:
      event.original.hardware.board_serial: $event.original.inventory.board_serial

    #inventory.cpu_name
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_name: +not_exists
    map:
      event.original.inventory.cpu_name: "NULL"
    #fill hardware.cpu_name
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_name: +exists
    map:
      event.original.hardware.cpu_name: event.original.inventory.cpu_name

    #inventory.cpu_cores
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_cores: +not_exists
    map:
      event.original.inventory.cpu_cores: "NULL"
    #fill hardware.cpu_cores
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_cores: +exists
    map:
      event.original.hardware.cpu_cores: event.original.inventory.cpu_cores

    #inventory.cpu_mhz
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_mhz: +not_exists
    map:
      event.original.inventory.cpu_mhz: "NULL"
    #fill hardware.cpu_mhz
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.cpu_mhz: +exists
    map:
      event.original.hardware.cpu_mhz: event.original.inventory.cpu_mhz

    #inventory.ram_total
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_total: +not_exists
    map:
      event.original.inventory.ram_total: "NULL"
    #fill hardware.ram_total
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_total: +exists
    map:
      event.original.hardware.ram_total: event.original.inventory.ram_total

    #inventory.ram_free
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_free: +not_exists
    map:
      event.original.inventory.ram_free: "NULL"
    #fill hardware.ram_free
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_free: +not_exists
    map:
      event.original.hardware.ram_free: event.original.inventory.ram_free

    #inventory.ram_usage
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_usage: +exists
    map:
      event.original.inventory.ram_usage: "NULL"
    #fill hardware.ram_usage
  - check:
    - event.original.inventory: +exist
    - event.original.inventory.ram_usage: +exists
    map:
      event.original.hardware.ram_usage: event.original.inventory.ram_usage

  - check:
    - _decode_hardware_section: +i_eq/1
    - event.original.inventory: +exist
    map:
      _query_save: +s_concat/agent /$event.original.agent.id /hardware save /$event.original.ID/|$event.original.timestamp/|$event.original.inventory.board_serial/|$event.original.inventory.cpu_name/|$event.original.inventory.cpu_cores/|$event.original.inventory.cpu_mhz/|$event.original.inventory.ram_total/|$event.original.inventory.ram_free/|$event.original.inventory.ram_usage
      _hardware_save_response: +wdb_update/$_query_save
