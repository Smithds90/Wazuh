name: decoder_dbsync

check:
  - queue: +i_eq/35

parse:
  logql:
    - event.original: <_dbsyncEventOriginal/json>

normalize:
  - check:
      - _dbsyncEventOriginal.type: +s_starts/integrity_check_
    map:
      _query: +s_concat/agent /$agent.id/ /$component/ /$type/ /$data_plain
      _query_response: +wdb_query/$query
  - check:
      - _query_response: +exists
    map:
      _query_response.data.tail: +delete_field
      _query_response.data.checksum: +delete_field
      _ar_query: +s_concat/$component/ dbsync /$query_response/ /$data_plain
      _ar_result: +ar_write/$ar_query

  - check:
      - _dbsyncEventOriginal.type: +s_eq/state
    map:
      _query: +s_concat/agent /$agent.id/ /$component/ save2 /$data_plain
      _query_status: +wdb_update/$query

  - check:
      - _dbsyncEventOriginal.type: +s_eq/integrity_clear
    map:
      _query: +s_concat/agent /$agent.id/ /$component/ integrity_clear /$data_plain
      _query_status: +wdb_update/$query
