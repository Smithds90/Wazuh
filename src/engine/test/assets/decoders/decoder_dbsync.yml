name: decoder_dbsync

check:
  - wazuh.queue: 53 # DBSYNC_MQ '5'

parse:
  logql:
    - event.original: <_dbsyncEventOriginal/json>

normalize:
  - check:
      - _dbsyncEventOriginal.type: +s_starts/integrity_check_
    map:
      _query: +s_concat/agent /$agent.id/ /$_dbsyncEventOriginal.component/ /$_dbsyncEventOriginal.type/ /$_dbsyncEventOriginal.data
      _query_response: +wdb_query/$_query
  - check:
      - _query_response: +exists
    map:
      _ar_query: +s_concat/(msg_to_agent) [] N!S /$agent.id/ /$_dbsyncEventOriginal.component/ dbsync /$_query_response/ /$_dbsyncEventOriginal.data
      _ar_result: +ar_write/$_ar_query

  - check:
      - _dbsyncEventOriginal.type: +s_eq/state
    map:
      _query: +s_concat/agent /$agent.id/ /$_dbsyncEventOriginal.component/ save2 /$_dbsyncEventOriginal.data
      _query_status: +wdb_update/$_query

  - check:
      - _dbsyncEventOriginal.type: +s_eq/integrity_clear
    map:
      _query: +s_concat/agent /$agent.id/ /$_dbsyncEventOriginal.component/ integrity_clear /$_dbsyncEventOriginal.data
      _query_status: +wdb_update/$_query
