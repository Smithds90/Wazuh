name: decoder/syscollector-dbsync-hotfixes/0

parents:
  - decoder/syscollector-dbsync-base/0

check:
  - _json.type: +s_eq/dbsync_hotfixes
  - _json.operation: +s_ne/INSERTED

normalize:
  - check:
      - _json.data.scan_time: +not_exists
    map:
      - _json.data.scan_time: "NULL"

  - check:
      - _json.data.hotfix: +exists
    map:
      - _json.data.hotfix: +s_replace/|/$_escaped_pipe_char

  - check:
      - _json.data.hotfix: +not_exists
    map:
      - _json.data.hotfix: "NULL"

  - check:
      - _json.data.checksum: +not_exists
    map:
      - _json.data.checksum: "NULL"

  - map:
      - _query: +s_concat/agent /$agent.id/ dbsync hotfixes /$_json.operation/ /$_json.data.scan_time/|/$_json.data.hotfix/|/$_json.data.checksum/|
      - _query: +s_replace/||/|NULL|
      - _query_response: +wdb_query/$_query

  - check:
      - _query_response: +s_ne//
    map:
      #separate in spaces because answer is "date value1|value2|..."
      - _query_response_space_splited: "+s_to_array/$_query_response/ "
      #leaving just pipe separated part
      - _query_response_values: $_query_response_space_splited/1
      #separting values in between pipes
      - _array_of_field: +s_to_array/$_query_response_values/|
      - _json.data.hotfix: $_array_of_field/1
      #replace spcaped values
      - _json.data.hotfix: +s_replace/$_escaped_pipe_char/|
      - wazuh.syscollector.hotfix: $_json.data.hotfix
      - _query: +delete_field
      - _query_response: +delete_field
      - _query_response_values: +delete_field
      - _array_of_field: +delete_field
      - _escaped_pipe_char: +delete_field
      - _json.data: +delete_field
