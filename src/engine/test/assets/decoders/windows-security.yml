name: windows-security

parents:
  - json

metadata:
  description: Windows Server 2019 is the operating system that bridges on-premises environments, ad
    ding additional layers of security while helping you modernize your applications.
  references:
    - 'https://docs.microsoft.com/en-us/security/'
  product.name: Microsoft Windows Security Auditing
  product.versions:
    - '2019'
  formats:
    - 'json'
    - 'evtx'

check:
  - _jsonEventOriginal.win.system.channel: Security

normalize:
  - check:
      - _jsonEventOriginal.win.eventdata.targetUserSid: +exists
    map:
      group.id: $_jsonEventOriginal.win.eventdata.targetUserSid

  - check:
      - _jsonEventOriginal.win.eventdata.targetSid: +exists
    map:
      group.id: $_jsonEventOriginal.win.eventdata.targetSid

  - map:
      event.code: $_jsonEventOriginal.win.system.eventID
      event.provider: Microsoft-Windows-Security-Auditing
      event.module: security
      group.name: $_jsonEventOriginal.win.eventdata.targetUserName
      group.domain: $_jsonEventOriginal.win.eventdata.targetDomainName
      process.executable: $_jsonEventOriginal.win.eventdata.processName
      process.pid: $_jsonEventOriginal.win.eventdata.processId
      process.command_line: $_jsonEventOriginal.win.eventdata.commandLine
      related.user: +s_append/$_jsonEventOriginal.win.userData.subjectUserName
      source.domain: $_jsonEventOriginal.win.eventdata.workstationName
      source.ip: $_jsonEventOriginal.win.eventdata.ipAddress
      source.port: $_jsonEventOriginal.win.eventdata.ipPort
      service.name: $_jsonEventOriginal.win.eventdata.serviceName
      #service.type: $cdb_security.serviceTypes.$(_json.win.eventdata.ServiceType)
      user.domain: $_jsonEventOriginal.win.eventdata.subjectDomainName
      user.id: $_jsonEventOriginal.win.eventdata.subjectUserSid
      user.name: $_jsonEventOriginal.win.eventdata.subjectUserName
      user.target.group.id: $group.id
      user.target.group.name: $group.name
      user.target.group.domain: $group.domain

  # - check:
  #     - event.code: +exists
  #   map:
  #     # event.category: [ "$cdb_security.eventActionTypes.$(event.code)[0]" ]
  #     # event.type: [ "$cdb_security.eventActionTypes.$(event.code)[1]" ]
  #     event.action: +db_map/windows-security/eventActionTypes.<$event.code>[2]

  - check:
      - user.id: +exists
    map:
      user.target.id: $_jsonEventOriginal.win.eventdata.targetUserSid

  - check:
      - user.id: +not_exists
    map:
      user.id: $_jsonEventOriginal.win.eventdata.targetUserSid

  - check:
      - user.domain: +exists
    map:
      user.target.domain: $_jsonEventOriginal.win.eventdata.targetDomainName

  - check:
      - user.domain: +not_exists
    map:
      user.domain: $_jsonEventOriginal.win.eventdata.targetDomainName

  # - check:
  #     - process.name: +not_exists
  #   map:
  #     process.name: +base_name/$process.executable

  # - check:
  #     - process.parent.name: +not_exists
  #   map:
  #     process.parent.name: +base_name/$process.parent.executable

  # - check:
  #     - user.name: +exists
  #   capture:
  #     _json.win.eventdata.targetUserName: '+check/(.*)@'
  #   map:
  #     user.target.name: $1
  #     related.user: [$user.target.name ]

  # - check:
  #     - user.name: +not_exists
  #   capture:
  #     _json.win.eventdata.targetUserName: '+check/(.*)@'
  #   map:
  #     user.name: $1
  #     related.user: [$user.target.name ]
