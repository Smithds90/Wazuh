name: windows-security

parents:
  - windows-base

metadata:
  description: Windows Server 2019 is the operating system that bridges on-premises environments, ad
    ding additional layers of security while helping you modernize your applications.
  references:
    - 'https://docs.microsoft.com/en-us/security/'
  product.name: Microsoft Windows Security Auditing
  product.versions:
    - '2019'
  formats:
    - 'json'
    - 'evtx'

check:
  - winlog.channel: Security

normalize:
  - map:
      event.code: $winlog.event_id
      event.provider: Microsoft-Windows-Security-Auditing
      event.module: security
      event: +kvdb_get_merge/win-security-categorization/$event.code
      event.kind: event


  # Subject User from Event Data
  # TODO: tweak once in place kvdbs are implemented
  # TODO: using helper append cause yml parser fails to recognize it as string
  - map:
      _tmp.SubjUserCodes: "+s_append\
              /4657/4670/4672/4673/4674/4688/4689/4697\
              /4698/4699/4700/4701/4702/4706/4707/4713\
              /4716/4717/4718/4719/4720/4722/4723/4724\
              /4725/4726/4727/4728/4729/4730/4731/4732\
              /4733/4734/4735/4737/4738/4739/4740/4741\
              /4742/4743/4744/4745/4746/4747/4748/4749\
              /4750/4751/4752/4753/4754/4755/4756/4757\
              /4758/4759/4760/4761/4762/4763/4764/4767\
              /4781/4798/4799/4817/4904/4905/4907/4912\
              /4648"
  - check:
      - _tmp.SubjUserCodes: +s_contains/$event.code
    map:
      user.id: $winlog.event_data.SubjectUserSid
      user.name: $winlog.event_data.SubjectUserName
      user.domain: $winlog.event_data.SubjectDomainName

  # Target User to Effective
  - check: event.code==4648 OR event.code==4688
    map:
      user.effective.id: $winlog.event_data.TargetUserSid
      user.effective.name: $winlog.event_data.TargetUserName
      user.effective.domain: $winlog.event_data.TargetDomainName

  # Event 4688
  # {"Message": "message", "Event": "<Event xmlns='http://schemas.microsoft.com/win/2004/08/events/event'><System><Provider Name='Microsoft-Windows-Security-Auditing' Guid='{54849625-5478-4994-a5ba-3e3b0328c30d}' /><EventID>4688</EventID><Version>2</Version><Level>0</Level><Task>13312</Task><Opcode>0</Opcode><Keywords>0x8020000000000000</Keywords><TimeCreated SystemTime='2019-11-14T17:10:15.1515514Z' /><EventRecordID>5010</EventRecordID><Correlation /><Execution ProcessID='4' ThreadID='5076' /><Channel>Security</Channel><Computer>vagrant</Computer><Security /></System><EventData><Data Name='SubjectUserSid'>S-1-5-21-1610636575-2290000098-1654242922-1000</Data><Data Name='SubjectUserName'>vagrant</Data><Data Name='SubjectDomainName'>VAGRANT</Data><Data Name='SubjectLogonId'>0x274a2</Data><Data Name='NewProcessId'>0x11cc</Data><Data Name='NewProcessName'>C:\\Windows\\System32\\wevtutil.exe</Data><Data Name='TokenElevationType'>%%1937</Data><Data Name='ProcessId'>0x122c</Data><Data Name='CommandLine'>'C:\\Windows\\system32\\wevtutil.exe' cl Security</Data><Data Name='TargetUserSid'>S-1-0-0</Data><Data Name='TargetUserName'>-</Data><Data Name='TargetDomainName'>-</Data><Data Name='TargetLogonId'>0x0</Data><Data Name='ParentProcessName'>C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe</Data><Data Name='MandatoryLabel'>S-1-16-12288</Data></EventData></Event>"}
  - check:
      - event.code: +s_eq/4688
    map:
      process.pid: $winlog.event_data.NewProcessId # TODO: to long
      process.executable: $winlog.event_data.NewProcessName
      process.name: +r_ext/$process.executable/^.+\\(.+)$
      process.parent.pid: $winlog.event_data.ProcessId # TODO: to long
      process.parent.executable: $winlog.event_data.ParentProcessName
      process.parent.name: +r_ext/$process.parent.executable/^.+\\(.+)$
      process.args: "+s_to_array/$winlog.event_data.CommandLine/ "
      process.command_line: $winlog.event_data.CommandLine

  # Related User
  - map:
      _tmp.RelatedUserCodes: +s_append/4688/4720/4722/4723/4724/4725/4726/4738/4740/4767/4798
  - check:
      - _tmp.RelatedUserCodes: +s_contains/$event.code
      - winlog.event_data.TargetUserName: +s_ne/-
    map:
      related.user: +s_append/$winlog.event_data.TargetUserName
  - check:
      - user.name: +s_ne/-
    map:
      related.user: +s_append/$user.name


  # Delete tmp fields
  - map:
      _tmp: +delete_field
