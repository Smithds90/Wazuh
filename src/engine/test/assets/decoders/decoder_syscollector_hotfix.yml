name: decoder_syscollector_hotfix

parents:
  - decoder_syscollector_base

check:
  - type: +exists

normalize:
  # decode_hotfix
  #ID (scan_id)
  # type == hotfix || type == hotfix_end
  - check:
    - event.original.type: +s_eq/hotfix_end
    - event.original.ID: +exists
    - event.original.hotfix: +exist
    map:
      _decode_hotfix_section: 1

  - check:
    - _pre_conditions: +i_eq/1
    - event.original.type: +s_eq/hotfix
    - event.original.ID: +exists
    - event.original.hotfix: +exists
    map:
      _decode_hotfix_section: 1

  - check:
    - _decode_hotfix_section: +i_eq/1
    - event.original.hotfix: +exists
    map:
      _query_save: +s_concat/agent /$event.original.agent.id /hotfix save /$event.original.ID/|$event.original.timestamp/|$event.original.hotfix

  - check:
    - _decode_hotfix_section: +i_eq/1
    - event.original.hotfix: +not_exists
    - event.original.type: +s_eq/hotfix_end
    map:
      _query_del: +s_concat/agent /$event.original.agent.id /hotfix del /$event.original.ID
      _hotfix_del_response: +wdb_update/$_query_del

  - check:
    - _decode_hotfix_section: +i_eq/1
    - event.original.port: +not_exists
    - event.original.type: +s_eq/port_end
    - _error_port: +i_ne/1
    - _prev_port_id: +s_neq/$event.original.ID
    map:
      _error_port: 0
      _query_del: +s_concat/agent /$event.original.agent.id /port del /$event.original.ID


