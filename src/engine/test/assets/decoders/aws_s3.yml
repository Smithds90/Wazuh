---
name: aws_s3

metadata:
  description: Decoder for Amazon S3 server access logs
  references:
    - https://docs.aws.amazon.com/AmazonS3/latest/userguide/LogFormat.html
  product.name: Amazon S3 server access

parents:
  - aws

check:
  - wazuh.modules.aws.source: +s_eq/s3_server_access

// TODO: fix the multiple parsing
parse:
  logql:
    - _json.aws.request_uri: <http.request.method> <http.url.original> HTTP/<http.version>
    - _json.aws.request_uri: <http.request.method> <http.url.original> http/<http.version>

  logql:
    - _json.aws.host_header: <_>.<cloud.region>.<_>.<_>

  logql:
    - _json.aws.tls_version: <tls.version_protocol>V<tls.version>

normalize:
  - check:
      - _json.aws.error_code: +exists
    map:
      event.outcome: failure

  - check:
      - _json.aws.error_code: +not_exists
    map:
      event.outcome: success

  - map:
      aws.s3access.authentication_type: $_json.aws.authentication_type
      aws.s3access.bucket_owner: $_json.aws.bucket_owner
      aws.s3access.bucket: $_json.aws.bucket
      aws.s3access.bytes_sent: $_json.aws.bytes_sent
      aws.s3access.cipher_suite: $_json.aws.cipher_suite
      aws.s3access.error_code: $_json.aws.error_code
      aws.s3access.host_header: $_json.aws.host_header
      aws.s3access.host_id: $_json.aws.host_id
      aws.s3access.http_status: $_json.aws.http_status
      aws.s3access.key: $_json.aws.key
      aws.s3access.object_size: $_json.aws.object_sent
      aws.s3access.operation: $_json.aws.operation
      aws.s3access.referrer: $_json.aws.referer
      aws.s3access.remote_ip: $_json.aws.remote_ip
      aws.s3access.request_id: $_json.aws.request_id
      aws.s3access.request_uri: $_json.aws.request_uri
      aws.s3access.requester: $_json.aws.requester
      aws.s3access.signature_version: $_json.aws.signature_version
      aws.s3access.tls_version: $_json.aws.tls_version
      aws.s3access.total_time: $_json.aws.total_time
      aws.s3access.turn_around_time: $_json.aws.turn_around_time
      aws.s3access.user_agent: $_json.aws.user_agent
      aws.s3access.version_id: $_json.aws.version_id

      client.address: $_json.aws.remote_ip
      client.ip: $_json.aws.remote_ip
      client.user.id: $_json.aws.requester

      cloud.provider: aws

      event.action: $_json.aws.operation
      event.category: +s_append/web
      event.code: $_json.aws.error_code
      event.duration: $_json.aws.total_time # ms - ECS transforms this field to nanoseconds
      event.id: $_json.aws.request_id
      event.kind: event
      event.type: +s_append/access

      http.request.referrer: $_json.aws.referer
      http.response.body.bytes: $_json.aws.bytes_sent
      http.response.status_code: $_json.aws.http_status

      related.ip: +s_append/$_json.aws.remote_ip
      related.user: +s_append/$_json.aws.bucket_owner

      timestamp: $_json.aws.time

      tls.cipher: $_json.aws.cipher_suite

      _json: +delete_field
