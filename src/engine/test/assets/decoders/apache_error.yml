---
name: apache_error
parents:
  - default_decoder

metadata:
  description: Parses Apache HTTPD errors logs in its Common Log Format

check:
  - event.original: +exists

parse:
  logql:
      # [Mon Dec 26 16:15:55.103786 2016] [core:notice] [pid 11379] AH00094: Command line: '/usr/local/Cellar/httpd24/2.4.23_2/bin/httpd'
      - event.original: '[<timestamp/APACHE_ERROR>] [<_module>:<log.level>] [pid <process.pid>] <message>'
      # [Fri Sep 09 10:42:29.902022 2011] [core:error] [pid 35708:tid 4328636416] [client 72.15.99.187] File does not exist: /usr/local/apache2/htdocs/favicon.ico
      - event.original: '[<timestamp/APACHE_ERROR>] [<_module>:<log.level>] [pid <process.pid>:tid <process.thread.id>] [client <source.address>] <message>'
      # [Thu Jun 27 06:58:09.169510 2019] [include:warn] [pid 15934] [client 123.123.123.123:12345] AH01374: mod_include: Options +Includes (or IncludesNoExec) wasn't set, INCLUDES filter removed: /test.html
      - event.original: '[<timestamp/APACHE_ERROR>] [<_module>:<log.level>] [pid <process.pid>] [client <source.address>] <message>'
      # [Mon Dec 26 16:22:08 2016] [error] [client 192.168.33.1] File does not exist: /var/www/favicon.ico
      - event.original: '[<timestamp/APACHE_ERROR2>] [<log.level>] [client <source.ip>] <message>'
      # [Mon Dec 26 16:17:53 2016] [notice] Apache/2.2.22 (Ubuntu) configured -- resuming normal operations
      - event.original: '[<timestamp/APACHE_ERROR2>] [<log.level>] <message>'

normalize:
  - map:
     event.kind: event
     event.dataset: apache.error
     event.category: +s_append/web
     event.module: apache
     service.type: apache
     event.type: +s_append/info
  - check:
      - log.level: +r_match/^[eacw]
    map:
      event.type: +s_append/error
