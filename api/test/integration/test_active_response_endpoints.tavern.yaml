---
test_name: PUT /active-response/{:agent_id}

marks:
  - usefixtures:
    - base_tests

includes:
  - !include common.yaml

stages:

    # Authentication stage
  - type: ref
    id: login_get_token

    # PUT /active-response/001
  - name: Runs an Active Response command on a specified agent
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/001"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 200
      body:
        message: Command sent.

    # PUT /active-response/002
  - name: Send a message to an agent (Status=Active)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/002"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 200
      body:
        message: Command sent.

    # PUT /active-response/009
  - name: Try to send a message to an agent (Status=Disconnected/Never connected)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/009"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 400
      body:
        code: 1651
        dapi_errors: !anything
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

    # PUT /active-response/003
  - name: Try to send a message to an agent (Active response disabled)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/003"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 400
      body:
        code: 1750
        dapi_errors: !anything
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

    # PUT /active-response/251
  - name: Try to send a message to an unexisting agent
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/251"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
          command: "restart-ossec0"
          arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 400
      body:
        code: 1701
        dapi_errors: !anything
        detail: !anystr
        status: 400
        title: !anystr
        type: !anystr

    # PUT /active-response/004
  - name: Try to send a message to an agent, without body
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/004"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 400

    # PUT /active-response/005
  - name: Try to send a message to an agent, malformed body
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response/005"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        comMmand: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 400

---
test_name: PUT /active-response

stages:

    # PUT /active-response
  - name: Runs an Active Response command on all agents
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        command: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
        status_code: 200
        body:
          message: "Command sent to all agents."

    # PUT /active-response
  - name: Try to send a message to all agents, malformed body
    request:
      url: "{protocol:s}://{host:s}:{port:d}/active-response"
      method: PUT
      headers:
        Authorization: "Bearer {test_login_token}"
        content-type: application/json
      json:
        comMmand: "restart-ossec0"
        arguments: ["-", "null", "(from_the_server)", "(no_rule_id)"]
    response:
      status_code: 400

