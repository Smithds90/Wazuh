
---
test_name: GET /vulnerability/{agent_id}

stages:

  - name: Try to get vulnerabilities information for agent 001
    request:
      verify: False
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability/001"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        limit: 1
    response: &permission_denied
      status_code: 403
      json:
        error: 4000

  - name: Get vulnerabilities information for agent 002
    request:
      verify: False
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability/002"
      method: GET
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        limit: 1
    response:
      status_code: 200
      json:
        error: 0
        data:
          affected_items: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

---
test_name: GET /vulnerability/{agent_id}/last_scan

stages:

  - name: Try to get when the last full and partial scans for agent 001 ended
    request:
      verify: False
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability/001/last_scan"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      <<: *permission_denied

  - name: Get when the last full and partial scans for agent 002 ended
    request:
      verify: False
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability/002/last_scan"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      json:
        error: 0
        data:
          affected_items:
            - last_full_scan: !anything
              last_partial_scan: !anystr
          failed_items: [ ]
          total_affected_items: 1
          total_failed_items: 0

---
test_name: GET /vulnerability/{agent_id}/summary/severity

stages:

  - name: Try to get a summary of the vulnerabilities' severity of a given agent
    request:
      verify: False
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability/001/summary/severity"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      <<: *permission_denied

---
test_name: PUT /vulnerability

marks:
  # Marked as expected to fail until the core development is finished
  - xfail

stages:

  - name: Save name of nodes with at least one agent connected
    request:
      verify: False
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/agents/stats/distinct"
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        fields: node_name
      response:
        save:
          json:
            first_node_name: data.affected_items[0].node_name
            first_node_count: data.affected_items[0].count
            second_node_name: data.affected_items[1].node_name
            second_node_count: data.affected_items[1].count
            third_node_name: data.affected_items[2].node_name
            third_node_count: data.affected_items[2].count

  - name: Run vulnerability detector scans
    request:
      verify: False
      method: PUT
      url: "{protocol:s}://{host:s}:{port:d}/vulnerability"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      verify_response_with:
        - function: tavern_utils:test_validate_vd_scans
          extra_kwargs:
            first_node_name: "{first_node_name}"
            first_node_count: !int "{first_node_count}"
            second_node_name: "{second_node_name}"
            second_node_count: !int "{second_node_count}"
            third_node_name: "{third_node_name}"
            third_node_count: !int "{third_node_count}"
