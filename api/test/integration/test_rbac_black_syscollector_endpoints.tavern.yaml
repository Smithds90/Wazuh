---
test_name: GET OS SYSCOLLECTOR RBAC

includes:
 - !include common.yaml

marks:
  - usefixtures:
    - syscollector_black_rbac_tests

stages:

  - type: ref
    id: login_get_token

  - name: Get os from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/os"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - architecture: !anystr
              hostname: !anystr
              os:
                codename: !anystr
                major: !anystr
                minor: !anystr
                name: !anystr
                platform: !anystr
                version: !anystr
              release: !anystr
              scan:
                id: !anyint
                time: !anystr
              sysname: !anystr
              version: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown

  - name: Get os from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/001/os"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body: &permission_denied
        code: 4000
        dapi_errors: !anything
        detail: Permission denied
        remediation: !anystr
        status: 400
        title: Wazuh Error
        type: about:blank

---
test_name: GET HARDWARE SYSCOLLECTOR RBAC

stages:

  - name: Get hardware from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/hardware"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - board_serial: !anything
              cpu:
                cores: !anything
                mhz: !anything
                name: !anything
              ram:
                free: !anything
                total: !anything
                usage: !anything
              scan:
                id: !anything
                time: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown

  - name: Get hardware from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/001/hardware"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET NETADDR SYSCOLLECTOR RBAC

stages:

  - name: Get netaddr from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/netaddr"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - address: !anystr
              broadcast: !anystr
              iface: !anystr
              netmask: !anystr
              proto: !anystr
              scan:
                id: !anyint
          total_affected_items: !anyint

  - name: Get netaddr from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/001/netaddr"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET NETIFACE SYSCOLLECTOR RBAC

stages:

  - name: Get netiface from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/netiface"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - mac: !anystr
              mtu: !anyint
              name: !anystr
              rx:
                bytes: !anyint
                dropped: !anyint
                errors: !anyint
                packets: !anyint
              scan:
                id: !anyint
                time: !anystr
              state: !anystr
              tx:
                bytes: !anyint
                dropped: !anyint
                errors: !anyint
                packets: !anyint
              type: !anystr
          total_affected_items: !anyint

  - name: Get netiface from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/001/netiface"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET NETPROTO SYSCOLLECTOR RBAC

stages:

  - name: Get netiface from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/004/netproto"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - dhcp: !anystr
              gateway: !anystr
              iface: !anystr
              scan:
                id: !anyint
              type: !anystr
          total_affected_items: !anyint

  - name: Get netiface from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/005/netproto"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET PACKAGES SYSCOLLECTOR RBAC

stages:

  - name: Get netiface from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/004/packages"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        limit: 1
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - architecture: !anystr
              description: !anystr
              format: !anystr
              name: !anystr
              priority: !anystr
              scan:
                id: !anyint
                time: !anystr
              section: !anystr
              size: !anyint
              vendor: !anystr
              version: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown

  - name: Get netiface from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/005/packages"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET PORTS SYSCOLLECTOR RBAC

stages:

  - name: Get netiface from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/ports"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - inode: !anyint
              local:
                ip: !anystr
                port: !anyint
              protocol: !anystr
              remote:
                ip: !anystr
                port: !anyint
              rx_queue: !anyint
              scan:
                id: !anyint
                time: !anystr
              state: !anystr
              tx_queue: !anyint
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown

  - name: Get netiface from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/006/ports"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET PROCESSES SYSCOLLECTOR RBAC

stages:

  - name: Get netiface from an agent (Allow)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/processes"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
      params:
        limit: 1
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - cmd: !anystr
              egroup: !anystr
              euser: !anystr
              fgroup: !anystr
              name: !anystr
              nice: !anyint
              nlwp: !anyint
              pgrp: !anyint
              pid: !anystr
              ppid: !anyint
              priority: !anyint
              processor: !anyint
              resident: !anyint
              rgroup: !anystr
              ruser: !anystr
              scan:
                id: !anyint
                time: !anystr
              session: !anyint
              sgroup: !anystr
              share: !anyint
              size: !anyint
              start_time: !anyint
              state: !anystr
              stime: !anyint
              suser: !anystr
              tgid: !anyint
              tty: !anyint
              utime: !anyint
              vm_size: !anyint
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown

  - name: Get netiface from an agent (Deny)
    request:
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/006/processes"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

---
test_name: GET HOTFIXES SYSCOLLECTOR RBAC

marks:
  - xfail

stages:

  - name: Get all hotfixes from an agent (Allow)
    request: &hotfix_request_allow
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/002/hotfixes"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - hotfix: !anystr
              scan_id: !anyint
              scan_time: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
        message: All specified items were shown
      save:
        body:
          hotfix_filter: data.affected_items.0.hotfix

  - name: Filter hotfix (Allow)
    request:
      <<: *hotfix_request_allow
      params:
        hotfix: "{hotfix_filter}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - hotfix: "{hotfix_filter}"
              scan_id: !anyint
              scan_time: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

  - name: Get all hotfixes from an agent (Deny)
    request: &hotfix_request_deny
      url: "{protocol:s}://{host:s}:{port:d}/syscollector/000/hotfixes"
      headers:
        Authorization: "Bearer {test_login_token}"
      method: GET
    response:
      status_code: 400
      body:
        <<: *permission_denied

  - name: Filter hotfix (Deny)
    request:
      <<: *hotfix_request_deny
    response:
      status_code: 400
      body:
        <<: *permission_denied
