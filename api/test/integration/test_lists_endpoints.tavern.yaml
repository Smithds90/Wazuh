---
test_name: GET /lists

marks:
  - usefixtures:
    - base_tests

includes:
  - !include common.yaml

stages:

    # Authentication stage
  - type: ref
    id: login_get_token

    # GET /lists
  - name: Try to get all lists
    request: &get_lists
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/lists"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
          affected_items: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists?limit=0
  - name: Try to get lists using wrong limit parameter
    request:
      <<: *get_lists
      params:
        limit: 0
    response:
      status_code: 400

    # GET /lists?limit=1
  - name: Try to get lists using limit parameter
    request:
      <<: *get_lists
      params:
        limit: 1
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
              path: !anystr
          failed_items: []
          total_affected_items: 1
          total_failed_items: 0
      # Save some data for future use in the test
      save:
        body:
          returned_path: data.affected_items.0.path

    # We implement a dual stage to check offset parameter behaviour
    # GET /lists?limit=2&offset=0
  - name: Try to get lists using limit and offset parameter
    request:
      <<: *get_lists
      params:
        limit: 2
        offset: 0
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
              path: !anystr
            - items: !anything
              path: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
      # Save second item to check offset in next stage
      save:
        body:
          offset_item_path: data.affected_items.1.path

    # GET /lists?limit=1&offset=1
  - name: Try to get lists using limit and offset parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        offset: 1
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
              path: "{offset_item_path}"
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists?limit=1&search={returned_path:s}
  - name: Try to get lists using limit and search parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        search: "{returned_path:s}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists?limit=1&search=-{returned_path:s}
  - name: Try to get lists using limit and search parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        search: "-{returned_path:s}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists?limit=1&search=empty_search
  - name: Try to get lists using limit and an empty search parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        search: "empty_search"
    response:
      status_code: 200
      body:
        data:
          affected_items: []
          failed_items: []
          total_affected_items: 0
          total_failed_items: 0

    # GET /lists?limit=1&path={returned_path}
  - name: Try to get lists using limit and path parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        path: "{returned_path:s}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - items: !anything
              path: "{tavern.request_vars.params.path}"
          failed_items: []
          total_affected_items: 1
          total_failed_items: 0

    # GET /lists?limit=1&path=wrong_path
  - name: Try to get lists using limit and a wrong path parameter
    request:
      <<: *get_lists
      params:
        limit: 1
        path: "wrong_path"
    response:
      status_code: 400

    # GET /lists?path=etc/files/audit-keys.cdb
  - name: Try to get a CBD list from a bad format etc file path
    request:
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/lists"
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: "etc/lists/audit-keys.cdb"
    response:
      status_code: 400
      body:
        code: 1800

    # GET /lists?path=wrong_filepath
  - name: Try to get a CBD list from a non existing etc file path
    request:
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/lists"
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: "etc/lists/wrong_filepath"
    response:
      status_code: 400
      body:
        code: 1802

    # GET /lists?path=etc/lists/amazon
  - name: Try to get a CBD list from a directory instead of a file
    request:
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/lists"
      headers:
        Authorization: "Bearer {test_login_token}"
      params:
        path: "etc/lists/amazon"
    response:
      status_code: 400
      body:
        code: 1804

---
test_name: GET /lists/files

stages:

  # GET /lists/files
  - name: Try to get paths from all CDB lists
    request: &get_lists_files
      method: GET
      url: "{protocol:s}://{host:s}:{port:d}/lists/files"
      headers:
        Authorization: "Bearer {test_login_token}"
    response:
      status_code: 200
      body:
        data:
           # We get totalItems number of arrays in items, using !anything to check items key is in the response
          affected_items: !anything
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists/files?limit=0
  - name: Try to get paths from all CDB lists using wrong limit parameter
    request:
      <<: *get_lists_files
      params:
        limit: 0
    response:
      status_code: 400

    # GET /lists/files?limit=1
  - name: Try to get paths from all CDB lists using limit parameter
    request:
      <<: *get_lists_files
      params:
        limit: 1
    response:
      status_code: 200
      body:
        data:
          affected_items: &full_items_array_files
            - folder: !anystr
              name: !anystr
              path: !anystr
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
      # Save some data for future use in the test
      save:
        body:
          returned_folder: data.affected_items.0.folder
          returned_name: data.affected_items.0.name
          returned_path: data.affected_items.0.path

    # We implement a dual stage to check offset parameter behaviour
    # GET /lists/files?limit=2&offset=0
  - name: Try to get paths from all CDB lists using limit and offset parameter
    request:
      <<: *get_lists_files
      params:
        limit: 2
        offset: 0
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - <<: *full_items_array_files
            - <<: *full_items_array_files
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0
      # Save second item to check offset in next stage
      save:
        body:
          offset_item_folder: data.affected_items.1.folder
          offset_item_name: data.affected_items.1.name
          offset_item_path: data.affected_items.1.path

    # GET /lists/files?limit=1&offset=1
  - name: Try to get paths from all CDB lists using limit and offset parameter
    request:
      <<: *get_lists_files
      params:
        limit: 1
        offset: 1
    response:
      status_code: 200
      body:
        data:
          affected_items:
              # Check offset matches with previous request
            - folder: "{offset_item_folder}"
              name: "{offset_item_name}"
              path: "{offset_item_path}"
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists/files?limit=1&search={returned_path:s}
  - name: Try to get paths from all CDB lists using limit and search parameter
    request:
      <<: *get_lists_files
      params:
        limit: 1
        search: "{returned_path:s}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - <<: *full_items_array_files
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists/files?limit=1&search=-{returned_path:s}
  - name: Try to get paths from all CDB lists using limit and search parameter
    request:
      <<: *get_lists_files
      params:
        limit: 1
        search: "-{returned_path:s}"
    response:
      status_code: 200
      body:
        data:
          affected_items:
            - <<: *full_items_array_files
          failed_items: []
          total_affected_items: !anyint
          total_failed_items: 0

    # GET /lists/files?limit=1&search=empty_search
  - name: Try to get paths from all CDB lists using limit and an empty search parameter
    request:
      <<: *get_lists_files
      params:
        limit: 1
        search: "empty_search"
    response:
      status_code: 200
      body:
        data:
          affected_items: !anything
          failed_items: []
          total_affected_items: 0
          total_failed_items: 0
